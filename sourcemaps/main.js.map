{"version":3,"sources":["main.coffee"],"names":[],"mappings":"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","file":"main.js","sourceRoot":"/source/","sourcesContent":["\n\n\n\n############################################################################################################\n# njs_util                  = require 'util'\n# njs_path                  = require 'path'\n# njs_fs                    = require 'fs'\n#...........................................................................................................\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'kwic'\nlog                       = CND.get_logger 'plain',     badge\ninfo                      = CND.get_logger 'info',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\nalert                     = CND.get_logger 'alert',     badge\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\nhelp                      = CND.get_logger 'help',      badge\nurge                      = CND.get_logger 'urge',      badge\necho                      = CND.echo.bind CND\nTEXT                      = require 'coffeenode-text'\nCODEC                     = require 'hollerith-codec'\nLODASH                    = CND.LODASH\n\n\n#-----------------------------------------------------------------------------------------------------------\n@new_kwic = ( settings ) ->\n  factorizer  = settings?[ 'factorizer' ] ? null\n  alphabet    = settings?[ 'alphabet'   ] ? null\n  #.........................................................................................................\n  R =\n    '~isa':               'KWIC/base'\n    'entries':            null\n    'factors':            null\n    'factorizer':         factorizer\n    'alphabet':           alphabet\n    'weights':            null\n    'permutations':       null\n    'facets':             null\n  #.........................................................................................................\n  if ( entries = settings?[ 'entries' ] )?\n    @add R, entry for entry in entries\n    if alphabet?\n      @factorize\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@add = ( me, entry ) ->\n  ### TAINT consider to update or delete factors instead ###\n  throw new Error \"unable to add entries after factorization\" if me[ 'factors' ]?\n  ( me[ 'entries' ]?= [] ).push entry\n  return me\n\n#-----------------------------------------------------------------------------------------------------------\n@factorize = ( me, factorizer = null ) ->\n  ### TAINT consider to update or delete factors instead ###\n  throw new Error \"unable to factorize another time\" if me[ 'factors' ]?\n  me[ 'factors' ]   = []\n  factorizer       ?= @_get_factorizer me, factorizer\n  for entry in me[ 'entries' ]\n    me[ 'factors' ].push factor_list = factorizer entry\n  return me\n\n#-----------------------------------------------------------------------------------------------------------\n@_get_factorizer = ( me, factorizer = null ) ->\n  factorizer ?= me[ 'factorizer' ] ? 'characters'\n  switch type = CND.type_of factorizer\n    when 'function'\n      R = factorizer\n    when 'text'\n      R = @factorizers[ factorizer ]\n      throw new Error \"unknown factorizer name #{rpr factorizer}\" unless R?\n    else\n      throw new Error \"illegal factorizer type #{rpr type}\"\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@add_weights = ( me, alphabet = null ) ->\n  ### TAINT consider to factorize transparently ###\n  throw new Error \"unable to add weights before factorization\" unless me[ 'factors' ]?\n  ### TAINT consider to update or delete weights instead ###\n  throw new Error \"unable to factorize another time\" if me[ 'weights' ]?\n  weighter          = @_get_weighter me, alphabet\n  me[ 'weights' ]   = []\n  for factor_list in me[ 'factors' ]\n    me[ 'weights' ].push ( weighter factor for factor in factor_list )\n  return me\n\n#-----------------------------------------------------------------------------------------------------------\n@_get_weighter = ( me, alphabet = null ) ->\n  alphabet ?= me[ 'alphabet' ] ? 'unicode'\n  switch type = CND.type_of alphabet\n    when 'function'\n      R = alphabet\n    when 'text'\n      R = @alphabets[ alphabet ]\n      throw new Error \"unknown alphabet name #{rpr alphabet}\" unless R?\n    when 'list'\n      alphabet_pod = {}\n      do -> alphabet_pod[ factor ] = idx for factor, idx in alphabet\n      ### TAINT consider to throw error for unknown symbols ###\n      R = ( factor ) -> alphabet[ factor ] ? Infinity\n    else\n      throw new Error \"illegal alphabet type #{rpr type}\"\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@permute = ( me ) ->\n  ### TAINT consider to update or delete factors instead ###\n  throw new Error \"unable to permute before adding weights\" unless me[ 'weights' ]?\n  throw new Error \"unable to permute another time\" if me[ 'permutations' ]?\n  permutations  = me[ 'permutations' ] = []\n  #.........................................................................................................\n  for weights, weight_idx in me[ 'weights' ]\n    weights           = weights[ .. ]\n    factors           = me[ 'factors' ][ weight_idx ]\n    target            = []\n    permutation_count = weights.length\n    permutations.push target\n    weights.push -Infinity\n    for infix_idx in [ 0 ... permutation_count ]\n      prefix    = factors[ ... infix_idx ]\n      infix     = factors[ infix_idx ]\n      suffix    = factors[ infix_idx + 1 .. ]\n      ### Here we reverse the order of weights in the 'suffix' part of the weights (the part that comes\n      behind the guard value); this means that both prefix and suffix weights that are closer to the\n      infix have a stronger influence on the sorting than those that are further away. ###\n      r_idx     = permutation_count - infix_idx\n      r_weights = weights[ .. r_idx ].concat weights[ r_idx + 1 .. ].reverse()\n      target.push [ r_weights, [ prefix, infix, suffix, ], ]\n      #.....................................................................................................\n      weights   = weights[ .. ]\n      @_rotate_left weights\n  #.........................................................................................................\n  return me\n\n#-----------------------------------------------------------------------------------------------------------\n@sort = ( me ) ->\n  ### TAINT consider to update or delete factors instead ###\n  throw new Error \"unable to sort before permuting\" unless me[ 'permutations' ]?\n  throw new Error \"unable to sort another time\" if me[ 'facets' ]?\n  facets = me[ 'facets' ] = []\n  #.........................................................................................................\n  for entry, entry_idx in me[ 'entries' ]\n    permutation_list = me[ 'permutations' ][ entry_idx ]\n    for [ weights, lineup, ], weight_idx in permutation_list\n      key = CODEC.encode weights\n      facets.push [ key, weight_idx, weights, lineup, entry, ]\n  #.........................................................................................................\n  facets.sort ( a, b ) ->\n    return R unless ( R = a[ 0 ].compare b[ 0 ] ) is 0\n    return +1 if a[ 1 ] > b[ 1 ]\n    return -1 if a[ 1 ] < b[ 1 ]\n    return  0\n  #.........................................................................................................\n  return me\n\n\n#===========================================================================================================\n# FACTORIZERS AND ALPHABETS\n#-----------------------------------------------------------------------------------------------------------\n@factorizers = {\n  'characters':       TEXT.split.bind TEXT\n  }\n\n#-----------------------------------------------------------------------------------------------------------\n@alphabets = {\n  'unicode':          ( factor ) -> factor.codePointAt 0\n  }\n\n\n#===========================================================================================================\n# HELPERS\n#-----------------------------------------------------------------------------------------------------------\n@_rotate_right = ( list ) ->\n  return list if list.length < 2\n  list.unshift list.pop()\n  return list\n\n#-----------------------------------------------------------------------------------------------------------\n@_rotate_left = ( list ) ->\n  return list if list.length < 2\n  list.push list.shift()\n  return list\n\n###\nentries\nentries (what is being indexed)\nalphabet (what is used to index)\n###\n\n"]}